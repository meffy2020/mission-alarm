<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미션 플레이</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 20px 0;
        }
        .sensor-guide {
            font-size: 1.1rem;
            color: #666;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <span style="background: #eee; padding: 4px 8px; border-radius: 5px; font-size: 0.8rem;">mission</span>
            <h2 id="mission-title" style="margin-top: 10px;">로딩 중...</h2>
            <p id="mission-desc"></p>
            
            <!-- Quiz Area -->
            <div id="quiz-area" class="hidden">
                <h1 id="question-text"></h1>
                <div id="options-area" class="mission-options"></div>
            </div>

            <!-- Sensor Area -->
            <div id="sensor-area" class="hidden">
                <div id="sensor-guide-text" class="sensor-guide"></div>
                <div id="sensor-display" class="sensor-value">---</div>
                <p id="sensor-status">센서 연결 중...</p>
                <div style="height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 10px;">
                    <div id="sensor-bar" style="height: 100%; width: 0%; background: var(--primary); transition: width 0.3s;"></div>
                </div>
            </div>

            <p id="message"></p>
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script>
        let currentMissionId = 0;
        let correctAnswer = "";
        let missionType = "";
        let sensorCondition = null; // {type, condition, threshold}
        let pollInterval = null;

        async function loadMission() {
            const res = await fetch('/mission/data/random');
            if (res.ok) {
                const mission = await res.json();
                currentMissionId = mission.id;
                missionType = mission.type;
                
                document.getElementById('mission-title').innerText = mission.title;
                document.getElementById('mission-desc').innerText = mission.description;
                correctAnswer = mission.answer;

                if (mission.type === 'quiz') {
                    const content = JSON.parse(mission.content);
                    document.getElementById('quiz-area').classList.remove('hidden');
                    document.getElementById('question-text').innerText = content.question;
                    
                    const optionsHtml = content.options.map(opt => 
                        `<button class="option-btn" onclick="submitAnswer('${opt}')">${opt}</button>`
                    ).join('');
                    document.getElementById('options-area').innerHTML = optionsHtml;
                } else if (mission.type === 'sensor') {
                    const content = JSON.parse(mission.content);
                    sensorCondition = content;
                    document.getElementById('sensor-area').classList.remove('hidden');
                    document.getElementById('sensor-guide-text').innerText = content.guide;
                    startSensorPolling();
                }
            }
        }

        function startSensorPolling() {
            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch('/sensor/current');
                    if(res.ok) {
                        const data = await res.json();
                        updateSensorUI(data);
                    }
                } catch (e) {
                    console.error("Sensor poll error", e);
                }
            }, 500);
        }

        function updateSensorUI(data) {
            if(!sensorCondition) return;
            
            let currentVal = 0;
            let label = "";
            
            if(sensorCondition.sensor_type === 'distance') {
                currentVal = data.distance;
                label = "cm";
            } else if(sensorCondition.sensor_type === 'ldr') {
                currentVal = data.ldr;
                label = "lux";
            }

            document.getElementById('sensor-display').innerText = `${currentVal} ${label}`;
            
            // Check Success
            let isSuccess = false;
            const threshold = sensorCondition.threshold;
            
            if (sensorCondition.condition === 'lower' && currentVal < threshold) {
                isSuccess = true;
            } else if (sensorCondition.condition === 'higher' && currentVal > threshold) {
                isSuccess = true;
            } else if (sensorCondition.condition === 'range') {
                const minVal = sensorCondition.min;
                const maxVal = sensorCondition.max;
                if (currentVal >= minVal && currentVal <= maxVal) {
                    isSuccess = true;
                }
                // Update visual bar for range (center it visually roughly)
                // Simple visual hack: just show raw percentage against max
            }

            // Visual feedback
            let percentage = 0;
            if (sensorCondition.condition === 'range') {
                 percentage = Math.min(100, (currentVal / (sensorCondition.max * 1.5)) * 100);
            } else {
                 percentage = Math.min(100, (currentVal / (threshold * 2)) * 100);
            }
            
            document.getElementById('sensor-bar').style.width = `${percentage}%`;

            if(isSuccess) {
                document.getElementById('sensor-status').innerText = "✅ 조건 달성! 유지하세요...";
                document.getElementById('sensor-status').style.color = "green";
                
                // Simple debounce or immediate success
                clearInterval(pollInterval);
                completeMission(true);
            } else {
                document.getElementById('sensor-status').innerText = "조건을 만족시키세요.";
                document.getElementById('sensor-status').style.color = "#666";
            }
        }

        async function submitAnswer(answer) {
            if (answer === correctAnswer) {
                completeMission(true);
            } else {
                document.getElementById('message').innerText = "❌ 틀렸습니다! 다시 시도하세요.";
                document.getElementById('message').style.color = "red";
            }
        }

        async function completeMission(success) {
            if (getToken()) {
                const res = await fetch('/mission/log', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mission_id: currentMissionId, success: success })
                });
                
                // Double check if server accepted (for sensor strict mode)
                if(res.ok) {
                    const log = await res.json();
                    if(log.success) {
                        window.location.href = '/mission/success';
                    } else {
                        document.getElementById('message').innerText = "❌ 실패! 센서 값이 조건과 다릅니다.";
                         // Restart polling if failed
                        if(missionType === 'sensor') startSensorPolling();
                    }
                }
            } else {
                 window.location.href = '/mission/success';
            }
        }

        loadMission();
    </script>
</body>
</html>